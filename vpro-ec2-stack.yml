- name: setup vprofile stack
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
       - name: Import VPC setup variables
         include_vars: vars/output_vars

       - name: Import vprofile setup variables
         include_vars: vars/vprostacksetup

       - name: create a ec2 key
         ec2_key:
               name: vpro-key
               region: "{{region}}"
         register: vprokey_out

       - name: save private key information into the file loginkey_vpro.pem
         copy:
               content: "{{vprokey_out.key.private_key}}"
               dest: "./loginkey_vpro.pem"
               mode: 0600
         when: vprokey_out.changed

       - name: create security group for load balancer
         ec2_group:
               name: vproELB-sg
               description: allow port 80 from everywhere
               region: "{{region}}"
               vpc_id: "{{vpcid}}"
               rules:
                 - proto: tcp
                   from_port: 80
                   to_port: 80
                   cidr_ip: 0.0.0.0/0
         register: vproELBSG_out

       - name: create security group for Vprofile stack
         ec2_group:
              name: vproStack-sg
              description: allow port 80 from everywhere
              region: "{{region}}"
              vpc_id: "{{vpcid}}"
              purge_rules: no
              rules:
                   - proto: tcp
                     from_port: 80
                     to_port: 80
                     group_id: "{{vproELBSG_out.group_id}}"

                   - proto: tcp
                     from_port: 22
                     to_port: 22
                     group_id: "{{BastionSGid}}"
         register: vprostackSG_out

